pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
        BUILD_TAG = "${env.BUILD_NUMBER}"
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîç Checking out code..."
                checkout scm
                
                // Clean workspace
                sh 'rm -rf node_modules || true'
                sh 'rm -rf client/node_modules || true'
                sh 'rm -rf server/*/node_modules || true'
            }
        }
        
        stage('Environment Setup') {
            steps {
                echo "‚öôÔ∏è Setting up environment..."
                
                // Check if Node.js is available
                sh '''
                    if command -v node &> /dev/null; then
                        echo "Node.js is already installed"
                        node --version
                    else
                        echo "Installing Node.js..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                        node --version
                    fi
                '''
                
                // Check if Docker is available
                sh '''
                    if command -v docker &> /dev/null; then
                        echo "Docker is already installed"
                        docker --version
                    else
                        echo "Installing Docker..."
                        curl -fsSL https://get.docker.com -o get-docker.sh
                        sh get-docker.sh
                        sudo usermod -aG docker $USER
                        docker --version
                    fi
                '''
            }
        }
        
        stage('Server Dependencies') {
            steps {
                echo "üîß Installing server dependencies..."
                dir('server') {
                    // Install dependencies for all services
                    sh '''
                        # API Gateway
                        cd api-gateway && npm ci --only=production || npm install --only=production
                        cd ..
                        
                        # User Service
                        cd services/user-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Location Service
                        cd services/location-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Payment Service
                        cd services/payment-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Ride Service
                        cd services/ride-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Notification Service
                        cd services/notification-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Admin Service
                        cd services/admin-service && npm ci --only=production || npm install --only=production
                        cd ../..
                        
                        # Analytics Service
                        cd services/analytics-service && npm ci --only=production || npm install --only=production
                        cd ../..
                    '''
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo "üê≥ Building Docker images..."
                dir('server') {
                    // Make build script executable
                    sh 'chmod +x build-services.sh'
                    
                    // Build all services
                    sh '''
                        if ./build-services.sh; then
                            echo "‚úÖ All Docker images built successfully"
                        else
                            echo "‚ùå Docker build failed"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Docker Compose Test') {
            steps {
                echo "üß™ Testing Docker Compose setup..."
                dir('server') {
                    // Test docker-compose configuration
                    sh '''
                        # Validate docker-compose file
                        docker-compose config
                        
                        # Start services in background for testing
                        docker-compose up -d
                        
                        # Wait for services to start
                        sleep 30
                        
                        # Test health endpoints
                        curl -f http://localhost:3000/health || echo "API Gateway health check failed"
                        curl -f http://localhost:5001/health || echo "User Service health check failed"
                        curl -f http://localhost:5003/health || echo "Location Service health check failed"
                        
                        # Stop services
                        docker-compose down
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ Cleaning up..."
            dir('server') {
                sh '''
                    # Stop any running containers
                    docker-compose down || true
                    
                    # Clean up unused Docker resources
                    docker system prune -f || true
                '''
            }
        }
        
        success {
            echo "‚úÖ Build completed successfully!"
            sh '''
                echo "üéâ Ride-Sharing App build successful!"
                echo "üåê Services will be available on:"
                echo "   API Gateway: http://localhost:3000"
                echo "   User Service: http://localhost:5001"
                echo "   Location Service: http://localhost:5003"
                echo "   Payment Service: http://localhost:5004"
                echo "   Ride Service: http://localhost:5002"
                echo "   Notification Service: http://localhost:5005"
                echo "   Analytics Service: http://localhost:5006"
                echo "   Admin Service: http://localhost:5007"
            '''
        }
        
        failure {
            echo "‚ùå Build failed!"
            sh '''
                echo "üí• Ride-Sharing App build failed!"
                echo "Check the logs above for details."
            '''
        }
        
        cleanup {
            cleanWs()
        }
    }
} 